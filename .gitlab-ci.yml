  stages:
    - build
    - deploy

  variables:
    DOCKER_COMPOSE_FILE: "docker-compose.yaml"
    FRONTEND_SERVICE: "frontend"
    BACKEND_SERVICE: "backend"

  # Build Frontend Only If Changed
  build_frontend:
    stage: build
    rules:
      - if: '$CI_COMMIT_REF_NAME == "dev"'
        variables:
          DOCKER_COMPOSE_FILE: "docker-compose.dev.yaml"
          FRONTEND_SERVICE: "frontend-dev"
      - if: '$CI_COMMIT_REF_NAME == "main"'
        variables:
          DOCKER_COMPOSE_FILE: "docker-compose.yaml"
          FRONTEND_SERVICE: "frontend"
      - changes:
          - frontend/**
    tags:
      - shell
    script:
      - docker-compose -f $DOCKER_COMPOSE_FILE build $FRONTEND_SERVICE



  # Build Backend Only If Changed
  build_backend:
    stage: build
    rules:
      - if: '$CI_COMMIT_REF_NAME == "dev"'
        variables:
          DOCKER_COMPOSE_FILE: "docker-compose.dev.yaml"
          BACKEND_SERVICE: "backend-dev"
      - if: '$CI_COMMIT_REF_NAME == "main"'
        variables:
          DOCKER_COMPOSE_FILE: "docker-compose.yaml"
          BACKEND_SERVICE: "backend"
      - changes:
          - backend/**
    tags:
      - shell
    script:
      - docker-compose -f $DOCKER_COMPOSE_FILE build $BACKEND_SERVICE


  # Deploy to Development
  deploy_dev:
    stage: deploy
    only:
      - dev
    environment:
      name: development
    tags:
      - shell
    script:
      - printenv | grep -E '^(MONGO_URI|JWT_SECRET|STRIPE_SECRET_KEY|ADMIN_CODE|REACT_APP_STRIPE_PUBLIC_KEY|REACT_APP_PAYPAL_CLIENT_ID|RECIPIENT_EMAIL|SMTP_HOST|SMTP_USER|SMTP_PASS|NOTEBOOK_TOKEN)=' > .env.dev
      - chmod 600 .env.dev
      - docker-compose -f docker-compose.dev.yaml --env-file .env.dev up -d --no-build

  # Deploy to Production
  deploy_prod:
    stage: deploy
    only:
      - main
    environment:
      name: production
    tags:
      - shell
    script:
      - printenv | grep -E '^(MONGO_URI|JWT_SECRET|STRIPE_SECRET_KEY|ADMIN_CODE|REACT_APP_STRIPE_PUBLIC_KEY|REACT_APP_PAYPAL_CLIENT_ID|RECIPIENT_EMAIL|SMTP_HOST|SMTP_USER|SMTP_PASS|NOTEBOOK_TOKEN)=' > .env
      - chmod 600 .env
      - docker-compose -f docker-compose.yaml --env-file .env up -d --no-build
      